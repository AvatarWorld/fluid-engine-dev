<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Tutorial 2 - Using Mesh and Surface Set</title>
  <meta name="description" content="Introduction">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="http://fluidenginedevelopment.org/documentation/mesh.html">
  <link rel="alternate" type="application/rss+xml" title="Fluid Engine Development" href="/feed.xml">

  <!-- Place this tag in your head or just before your close body tag. -->
  <script async defer src="https://buttons.github.io/buttons.js"></script>

  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">

    <a class="site-title" href="/">Fluid Engine Development</a>

    <nav class="site-nav">
      <span class="menu-icon" onclick = "void(0)">
        <svg viewBox="0 0 18 15" width="18px" height="15px">
          <rect y="0.7" width="18" height="1.5"/>
          <rect y="6.8" width="18" height="1.5"/>
          <rect y="12.8" width="18" height="1.5"/>
        </svg>
      </span>

      <div class="trigger" onclick = "void(0)">
        
          
          <a class="page-link" href="/documentation/">Documentation</a>
          
        
          
          <a class="page-link" href="/code/">Code</a>
          
        
          
          <a class="page-link" href="/examples/">Examples</a>
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Tutorial 2 - Using Mesh and Surface Set</h1>
  </header>

  <div class="post-content">
    <div class="documentation">
  <div class="blog-post spacing">
    <hr />
    <ul>
      <li>
        <a href="/documentation/build.html">
          
          Build Instruction
          
        </a>
      </li>
      <li>
        <a href="/documentation/hello.html">
          
          Tutorial 1 - Hello, Jet!
          
        </a>
      </li>
      <li>
        <a href="/documentation/mesh.html">
          <strong>
          Tutorial 2 - Using Mesh and Surface Set
          </strong>
        </a>
      </li>
      <li>
        <a href="/documentation/python.html">
          
          Tutorial 3 - Using Python API
          
        </a>
      </li>
      <li>
        <a href="/documentation/manual_tests.html">
          
          Manual (Feature) Tests
          
        </a>
      </li>
      <li>
        <a href="/documentation/unit_tests.html">
          
          Unit Tests
          
        </a>
      </li>
      <li>
        <a href="/documentation/perf_tests.html">
          
          Performance Tests
          
        </a>
      </li>
      <li>
        <a href="/documentation/supported_plat.html">
          
          Supported Platforms
          
        </a>
      </li>
      <li>
        <a href="/doxygen/">
          C++ API Reference
        </a>
      </li>
      <li>
        <a href="/pdoc/">
          Python API Reference
        </a>
      </li>
    </ul>
    <hr />
    <h2 id="introduction">Introduction</h2>

<p>In this tutorial, we will extend our <a href="/documentation/hello.html">previous example</a> and learn how to use arbitrary input mesh in our scene. Also, we will see how to use multiple surfaces for either collider or emitter.</p>

<h2 id="initial-setup">Initial Setup</h2>

<p>Let’s start building our simulation by setting up the solver. This time, we will use <code class="highlighter-rouge">ApicSolver3</code> which is based on 3-D Affine Particle-in-Cell (APIC) solver from the Jiang et al.’s 2015 SIGGRAPH paper. You can use any other solvers to have mesh in the scene; APIC is used just for the demonstration purpose. Anyway, our starter code looks like below:</p>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code><span class="cp">#include &lt;jet/jet.h&gt;
</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">jet</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">solver</span> <span class="o">=</span> <span class="n">ApicSolver3</span><span class="o">::</span><span class="n">builder</span><span class="p">()</span>
                      <span class="p">.</span><span class="n">withResolution</span><span class="p">({</span><span class="mi">50</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">50</span><span class="p">})</span>
                      <span class="p">.</span><span class="n">withDomainSizeX</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                      <span class="p">.</span><span class="n">withOrigin</span><span class="p">({</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">})</span>
                      <span class="p">.</span><span class="n">makeShared</span><span class="p">();</span>

    <span class="c1">// More codes to come
</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">Frame</span> <span class="n">frame</span><span class="p">;</span> <span class="n">frame</span><span class="p">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">120</span><span class="p">;</span> <span class="o">++</span><span class="n">frame</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">solver</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">(</span><span class="n">frame</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>The code above builds APIC solver with 50 x 100 x 50 resolution which occupies 4m x 8m x 4m box, and the corner of the box is positioned at (-2m, -2m, -2m).</p>

<h2 id="loading-mesh">Loading Mesh</h2>

<p>Now consider we want to have a cup in our new scene and drop some water into it. In this example, we are going to use a mesh file for the cup and use that as our collider. Jet framework provides generic triangle mesh structure with <code class="highlighter-rouge">TriangleMesh3</code> class which also comes with OBJ file loader. Take a look at the following code:</p>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code><span class="k">auto</span> <span class="n">mesh</span> <span class="o">=</span> <span class="n">TriangleMesh3</span><span class="o">::</span><span class="n">builder</span><span class="p">().</span><span class="n">makeShared</span><span class="p">();</span>
<span class="n">std</span><span class="o">::</span><span class="n">ifstream</span> <span class="n">file</span><span class="p">(</span><span class="s">"cup.obj"</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">mesh</span><span class="o">-&gt;</span><span class="n">readObj</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file</span><span class="p">);</span>
    <span class="n">file</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
<span class="p">}</span>
</code></pre>
</div>

<p>This code will load the following cup model which can be found under <code class="highlighter-rouge">&lt;jet&gt;/resources</code> directory after building the code (thanks to <a href="https://github.com/alm3dga">Alexander M</a> for providing the model):</p>

<p><img src="/assets/images/documentation/mesh/cup.png" alt="Cup" title="Cup" width="400px" height="320px" /></p>

<h2 id="using-mesh">Using Mesh</h2>

<p>From our previous example, we simple plugged the sphere geometry to the collider. For <code class="highlighter-rouge">TriangleMesh3</code> to be used as an input to a collider or emitter, we need one more step to convert the mesh into volumetric geometry. Take a look at the following code first:</p>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code><span class="k">auto</span> <span class="n">cup</span> <span class="o">=</span> <span class="n">ImplicitTriangleMesh3</span><span class="o">::</span><span class="n">builder</span><span class="p">()</span>
               <span class="p">.</span><span class="n">withTriangleMesh</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
               <span class="p">.</span><span class="n">withResolutionX</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
               <span class="p">.</span><span class="n">makeShared</span><span class="p">();</span>
</code></pre>
</div>

<p>The code above takes <code class="highlighter-rouge">mesh</code> and wraps it <code class="highlighter-rouge">ImplicitTriangleMesh3</code>. This new class, <code class="highlighter-rouge">ImplicitTriangleMesh3</code>, converts mesh into a signed-distance field (SDF) using grid. In order to act as a collider surface or emitter volume, the surface must support SDF, and this new helper class provide such an interface. Other than the original mesh, this class also requires one more parameter that specifies the resolution of the SDF. We use 100 in this example.</p>

<p>Once the SDF is created, we can assign it to collider as usual:</p>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code><span class="k">auto</span> <span class="n">collider</span> <span class="o">=</span> <span class="n">RigidBodyCollider3</span><span class="o">::</span><span class="n">builder</span><span class="p">()</span>
                  <span class="p">.</span><span class="n">withSurface</span><span class="p">(</span><span class="n">cup</span><span class="p">)</span>
                  <span class="p">.</span><span class="n">makeShared</span><span class="p">();</span>

<span class="n">solver</span><span class="o">-&gt;</span><span class="n">setCollider</span><span class="p">(</span><span class="n">collider</span><span class="p">);</span>
</code></pre>
</div>

<h3 id="using-multiple-surfaces">Using Multiple Surfaces</h3>

<p>If we want to combine existing surfaces to a single surface, we can use merged OBJ file, but we can also define set of surfaces for better flexibility. Now, assume that we want to add two spheres into a single emitter input. We do that by introducing <code class="highlighter-rouge">SurfaceSet3</code> object as shown below:</p>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code><span class="k">auto</span> <span class="n">sphere1</span> <span class="o">=</span> <span class="n">Sphere3</span><span class="o">::</span><span class="n">builder</span><span class="p">()</span>
                   <span class="p">.</span><span class="n">withCenter</span><span class="p">({</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.01</span><span class="p">})</span>
                   <span class="p">.</span><span class="n">withRadius</span><span class="p">(</span><span class="mf">0.4</span><span class="p">)</span>
                   <span class="p">.</span><span class="n">makeShared</span><span class="p">();</span>

<span class="k">auto</span> <span class="n">sphere2</span> <span class="o">=</span> <span class="n">Sphere3</span><span class="o">::</span><span class="n">builder</span><span class="p">()</span>
                   <span class="p">.</span><span class="n">withCenter</span><span class="p">({</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">})</span>
                   <span class="p">.</span><span class="n">withRadius</span><span class="p">(</span><span class="mf">0.4</span><span class="p">)</span>
                   <span class="p">.</span><span class="n">makeShared</span><span class="p">();</span>

<span class="k">auto</span> <span class="n">spheres</span> <span class="o">=</span> <span class="n">SurfaceSet3</span><span class="o">::</span><span class="n">builder</span><span class="p">()</span>
                   <span class="p">.</span><span class="n">withSurfaces</span><span class="p">({</span><span class="n">sphere1</span><span class="p">,</span> <span class="n">sphere2</span><span class="p">})</span>
                   <span class="p">.</span><span class="n">makeShared</span><span class="p">();</span>

<span class="k">auto</span> <span class="n">emitter</span> <span class="o">=</span> <span class="n">VolumeParticleEmitter3</span><span class="o">::</span><span class="n">builder</span><span class="p">()</span>
                   <span class="p">.</span><span class="n">withSurface</span><span class="p">(</span><span class="n">spheres</span><span class="p">)</span>
                   <span class="p">.</span><span class="n">withSpacing</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">gridSpacing</span><span class="p">)</span>
                   <span class="p">.</span><span class="n">withJitter</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
                   <span class="p">.</span><span class="n">makeShared</span><span class="p">();</span>

<span class="n">solver</span><span class="o">-&gt;</span><span class="n">setParticleEmitter</span><span class="p">(</span><span class="n">emitter</span><span class="p">);</span>
</code></pre>
</div>

<p>As you can see, our new surface type, <code class="highlighter-rouge">SurfaceSet3</code> takes list of other surfaces (using <code class="highlighter-rouge">.withSurfaces({sphere1, sphere2})</code>) and merge them into a single surface object.</p>

<h3 id="putting-all-together">Putting All Together</h3>

<p>To complete the scene, we also need to add emitter. Including the emitter setup, below is our final code:</p>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code><span class="cp">#include &lt;jet/jet.h&gt;
</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">jet</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">solver</span> <span class="o">=</span> <span class="n">ApicSolver3</span><span class="o">::</span><span class="n">builder</span><span class="p">()</span>
                      <span class="p">.</span><span class="n">withResolution</span><span class="p">({</span><span class="mi">50</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">50</span><span class="p">})</span>
                      <span class="p">.</span><span class="n">withDomainSizeX</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                      <span class="p">.</span><span class="n">withOrigin</span><span class="p">({</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">})</span>
                      <span class="p">.</span><span class="n">makeShared</span><span class="p">();</span>

    <span class="c1">// Read mesh
</span>    <span class="k">auto</span> <span class="n">mesh</span> <span class="o">=</span> <span class="n">TriangleMesh3</span><span class="o">::</span><span class="n">builder</span><span class="p">().</span><span class="n">makeShared</span><span class="p">();</span>
    <span class="n">std</span><span class="o">::</span><span class="n">ifstream</span> <span class="n">file</span><span class="p">(</span><span class="s">"cup.obj"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">mesh</span><span class="o">-&gt;</span><span class="n">readObj</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file</span><span class="p">);</span>
        <span class="n">file</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// Convert to SDF
</span>    <span class="k">auto</span> <span class="n">cup</span> <span class="o">=</span> <span class="n">ImplicitTriangleMesh3</span><span class="o">::</span><span class="n">builder</span><span class="p">()</span>
                   <span class="p">.</span><span class="n">withTriangleMesh</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
                   <span class="p">.</span><span class="n">withResolutionX</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
                   <span class="p">.</span><span class="n">makeShared</span><span class="p">();</span>

    <span class="c1">// Setup collider
</span>    <span class="k">auto</span> <span class="n">collider</span> <span class="o">=</span> <span class="n">RigidBodyCollider3</span><span class="o">::</span><span class="n">builder</span><span class="p">()</span>
                      <span class="p">.</span><span class="n">withSurface</span><span class="p">(</span><span class="n">cup</span><span class="p">)</span>
                      <span class="p">.</span><span class="n">makeShared</span><span class="p">();</span>

    <span class="n">solver</span><span class="o">-&gt;</span><span class="n">setCollider</span><span class="p">(</span><span class="n">collider</span><span class="p">);</span>

    <span class="c1">// Setup emitter
</span>    <span class="k">const</span> <span class="kt">double</span> <span class="n">gridSpacing</span> <span class="o">=</span> <span class="n">solver</span><span class="o">-&gt;</span><span class="n">gridSpacing</span><span class="p">().</span><span class="n">x</span><span class="p">;</span>

    <span class="k">auto</span> <span class="n">sphere1</span> <span class="o">=</span> <span class="n">Sphere3</span><span class="o">::</span><span class="n">builder</span><span class="p">()</span>
                       <span class="p">.</span><span class="n">withCenter</span><span class="p">({</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.01</span><span class="p">})</span>
                       <span class="p">.</span><span class="n">withRadius</span><span class="p">(</span><span class="mf">0.4</span><span class="p">)</span>
                       <span class="p">.</span><span class="n">makeShared</span><span class="p">();</span>

    <span class="k">auto</span> <span class="n">sphere2</span> <span class="o">=</span> <span class="n">Sphere3</span><span class="o">::</span><span class="n">builder</span><span class="p">()</span>
                       <span class="p">.</span><span class="n">withCenter</span><span class="p">({</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">})</span>
                       <span class="p">.</span><span class="n">withRadius</span><span class="p">(</span><span class="mf">0.4</span><span class="p">)</span>
                       <span class="p">.</span><span class="n">makeShared</span><span class="p">();</span>

    <span class="k">auto</span> <span class="n">spheres</span> <span class="o">=</span> <span class="n">SurfaceSet3</span><span class="o">::</span><span class="n">builder</span><span class="p">()</span>
                       <span class="p">.</span><span class="n">withSurfaces</span><span class="p">({</span><span class="n">sphere1</span><span class="p">,</span> <span class="n">sphere2</span><span class="p">})</span>
                       <span class="p">.</span><span class="n">makeShared</span><span class="p">();</span>

    <span class="k">auto</span> <span class="n">emitter</span> <span class="o">=</span> <span class="n">VolumeParticleEmitter3</span><span class="o">::</span><span class="n">builder</span><span class="p">()</span>
                       <span class="p">.</span><span class="n">withSurface</span><span class="p">(</span><span class="n">spheres</span><span class="p">)</span>
                       <span class="p">.</span><span class="n">withSpacing</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">gridSpacing</span><span class="p">)</span>
                       <span class="p">.</span><span class="n">withJitter</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
                       <span class="p">.</span><span class="n">makeShared</span><span class="p">();</span>

    <span class="n">solver</span><span class="o">-&gt;</span><span class="n">setParticleEmitter</span><span class="p">(</span><span class="n">emitter</span><span class="p">);</span>

    <span class="c1">// Run simulation
</span>    <span class="k">for</span> <span class="p">(</span><span class="n">Frame</span> <span class="n">frame</span><span class="p">;</span> <span class="n">frame</span><span class="p">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">120</span><span class="p">;</span> <span class="o">++</span><span class="n">frame</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">solver</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">(</span><span class="n">frame</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>And the final result is shown below:</p>

<p><img src="/assets/images/documentation/mesh/mesh.gif" alt="Result" title="Result" /></p>

  </div>
</div>

  </div>

</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Fluid Engine Development</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>
            
              Doyub Kim
            
            </li>
            
            <li><a href="mailto:doyubkim@gmail.com">doyubkim@gmail.com</a></li>
            
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/doyubkim"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">doyubkim</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/doyub"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">doyub</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>This site is for the book, &quot;Fluid Engine Development&quot;, and its source code.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
